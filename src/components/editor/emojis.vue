<template>
    <div class="emoji" ref="emojis">
        <span class="emoji-btn my-face" @click="handleShow">
            <svg t="1638538958197" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="35621" width="26" height="26">
                <path d="M512.002 512.002m-491.988 0a491.988 491.988 0 1 0 983.976 0 491.988 491.988 0 1 0-983.976 0Z" fill="#FDDF6D" p-id="35622" />
                <path d="M617.43 931.356c-271.716 0-491.986-220.268-491.986-491.986 0-145.168 62.886-275.632 162.888-365.684C129.054 155.124 20.014 320.828 20.014 512c0 271.716 220.268 491.986 491.986 491.986 126.548 0 241.924-47.796 329.098-126.298-67.106 34.31-143.124 53.668-223.668 53.668z" fill="#FCC56B" p-id="35623" />
                <path
                    d="M600.658 785.74c-53.02 0-102-28.8-127.822-75.16-5.38-9.658-1.91-21.848 7.744-27.226 9.656-5.38 21.846-1.91 27.226 7.744 18.764 33.686 54.342 54.608 92.852 54.608 37.528 0 73.51-21.136 93.908-55.16 5.684-9.478 17.978-12.562 27.458-6.874 9.482 5.684 12.558 17.978 6.874 27.458-27.59 46.024-76.732 74.61-128.24 74.61zM832.922 448.042a20.01 20.01 0 0 1-17.504-10.28c-12.842-23.054-37.19-37.374-63.542-37.374-25.702 0-50.378 14.53-64.404 37.924-5.682 9.482-17.974 12.562-27.458 6.874-9.482-5.684-12.558-17.976-6.874-27.458 21.216-35.388 59.048-57.372 98.736-57.372 40.862 0 78.61 22.194 98.512 57.922 5.38 9.658 1.91 21.848-7.744 27.226a19.914 19.914 0 0 1-9.722 2.538z"
                    fill="#7F184C"
                    p-id="35624"
                />
                <path d="M430.556 420.388m-60.044 0a60.044 60.044 0 1 0 120.088 0 60.044 60.044 0 1 0-120.088 0Z" fill="#FFFFFF" p-id="35625" />
                <path d="M354.876 561.148c-36.536 0-66.158 29.62-66.158 66.156h132.314c0-36.536-29.62-66.156-66.156-66.156zM841.098 561.148c-36.536 0-66.156 29.62-66.156 66.156h132.314c-0.004-36.536-29.622-66.156-66.158-66.156z" fill="#F9A880" p-id="35626" />
                <path d="M683.276 29.354c-10.416-3.69-21.858 1.754-25.554 12.168-3.698 10.418 1.75 21.858 12.168 25.558C857.752 133.748 983.974 312.546 983.974 512c0 260.248-211.724 471.97-471.97 471.97S40.03 772.244 40.03 512 251.752 40.03 512 40.03c11.054 0 20.014-8.962 20.014-20.014S523.054 0 512 0C229.68 0 0 229.68 0 512s229.68 512 512 512 512-229.68 512-512c0-216.362-136.928-410.32-340.724-482.646z" fill p-id="35627" />
                <path
                    d="M600.658 785.742c51.512 0 100.652-28.586 128.244-74.606 5.684-9.478 2.608-21.774-6.874-27.458-9.48-5.684-21.774-2.608-27.458 6.874-20.398 34.024-56.382 55.158-93.908 55.158-38.51 0-74.09-20.924-92.852-54.608-5.38-9.656-17.57-13.124-27.226-7.744-9.658 5.38-13.124 17.568-7.744 27.226 25.816 46.358 74.794 75.158 127.818 75.158zM660.012 445.188c9.482 5.684 21.776 2.604 27.458-6.874 14.024-23.394 38.704-37.924 64.404-37.924 26.352 0 50.702 14.32 63.542 37.372a20.012 20.012 0 0 0 27.226 7.748c9.658-5.38 13.124-17.568 7.744-27.226-19.902-35.728-57.65-57.922-98.512-57.922-39.688 0-77.52 21.982-98.736 57.37-5.684 9.478-2.604 21.772 6.874 27.456zM510.614 420.388c0-44.144-35.914-80.058-80.058-80.058s-80.058 35.914-80.058 80.058 35.914 80.058 80.058 80.058 80.058-35.912 80.058-80.058z m-80.058 40.03c-22.072 0-40.03-17.958-40.03-40.03s17.958-40.03 40.03-40.03c22.072 0 40.03 17.958 40.03 40.03s-17.958 40.03-40.03 40.03z"
                    fill
                    p-id="35628"
                />
                <path d="M607.22 29.568m-20.014 0a20.014 20.014 0 1 0 40.028 0 20.014 20.014 0 1 0-40.028 0Z" fill p-id="35629" />
            </svg>
        </span>
        <transition name="opacity">
            <template v-if="first">
                <div v-show="show" class="emoji-container" @click="handleCheckEmojis">
                    <ul v-for="item,key in emojis" class="emoji-items" :class="{ show: key === currentEmoji }">
                        <li :data-text="['text', 'emoji'].includes(item.type) ? element.icon : `::${element.text}::`" class="emoji-item my-face" :class="[item.type]" v-for="element in item.container" v-html="element.icon"></li>
                    </ul>
                    <div class="emoji-nav" @click.stop>
                        <span :class="{ current: key === currentEmoji }" @click="currentEmoji=key;" v-for=",key  in emojis">{{ key }}</span>
                    </div>
                </div>
            </template>
        </transition>
    </div>
</template>
<script>
import { emojis } from "@/emojis";
export default {
    data () {
        return {
            first: false,
            show: false,
            emojis,
            currentEmoji: Object.keys(emojis)[0],
        }
    },
    mounted () {
        this.fun = (e) => {
            if (e.target !== this.$root.$el.getRootNode().host) {
                this.show = false
            }
        }
        this.fun2 = (e) => {
            if (this.$refs.emojis && !this.$refs.emojis.contains(e.target)) {
                this.show = false
            }
        }
        document.addEventListener('click', this.fun)
        // document 事件的 target 是自定义元素本身,不会到自定义元素内部去,需要在自定义元素类在做一次监听
        this.$root.$el.addEventListener('click', this.fun2)
    },
    beforeDestroy () {
        document.removeEventListener('click', this.fun)
        this.$root.$el.removeEventListener('click', this.fun2)
    },
    methods: {
        handleShow () {
            this.show = !this.show;
            this.first = true;
        },
        handleCheckEmojis (e) {
            if (e.target.tagName.toLocaleLowerCase() === 'li') {
                this.$emit('checked', e.target.dataset.text);
                this.show = false;
            }
        }
    },
}
</script>
<style lang="less" scoped>
@import url("../../styles/variables.less");
.emoji {
    position: relative;
    user-select: none;
    .emoji-btn {
        cursor: pointer;
        display: inline-block;
        width: 24px;
        height: 24px;
    }

    .emoji-container {
        background: #fff;
        position: absolute;
        z-index: 2;
        width: 330px;
        height: 240px;
        margin-top: 0.5em;
        box-shadow: #6464640d 0px 0px 1px, #6464640d 0px 2px 3px,
            #6464640d 0px 3px 6px, #6464640d 0px 4px 10px,
            #6464640d 0px 5px 15px, #6464640d 0px 6px 21px;
        display: flex;
        flex-direction: column;

        .emoji-nav {
            height: 32px;
            line-height: 32px;
            background-color: #ffffff;

            span {
                padding: 0 5px;
                display: inline-block;
                cursor: pointer;

                &.current {
                    background-color: #eee;
                }
            }
        }

        .emoji-items {
            flex: 1;
            margin: 0;
            padding: 10px 0 0 10px;
            list-style: none;
            display: none;
            overflow: scroll;

            &.show {
                display: block;
            }

            .emoji-item {
                list-style-type: none;
                background: #f7f7f7;
                padding: 5px 10px;
                border-radius: 5px;
                display: inline-block;
                font-size: 12px;
                line-height: 14px;
                margin: 0 10px 12px 0;
                cursor: pointer;
                -webkit-transition: 0.3s;
                transition: 0.3s;

                &.emoji {
                    line-height: 20px;
                    font-size: 20px;
                }

                &.image {
                    :deep(img) {
                        width: 20px;
                        pointer-events: none;
                    }
                }

                &:hover {
                    background: #eee;
                    box-shadow: 0 2px 2px 0 #00000024, 0 3px 1px -2px #00000033,
                        0 1px 5px 0 #0000001f;
                }
            }
        }
    }
}
</style>
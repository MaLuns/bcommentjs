<template>
    <div class="login-icon pointer">
        <template v-if="!user">
            <svg @click="showLoginPanel = true;" t="1638012972106" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15875" width="32" height="32">
                <path d="M575.215 547.318c53.367-24.316 90.562-78.011 90.562-140.522 0-85.257-69.149-154.383-154.406-154.383-85.299 0-154.427 69.126-154.427 154.383 0 62.49 37.172 116.185 90.562 140.522-87.156 27.24-150.586 108.698-150.586 204.715 0 12.071 9.779 21.827 21.827 21.827s21.827-9.756 21.827-21.827c0-94.161 76.613-170.774 170.776-170.774 94.184 0 170.797 76.613 170.797 170.774 0 12.071 9.756 21.827 21.827 21.827 12.07 0 21.827-9.756 21.827-21.827 0.021-95.994-63.43-177.475-150.586-204.715zM400.621 406.817c0-61.072 49.678-110.729 110.773-110.729 61.072 0 110.75 49.657 110.75 110.729 0 61.094-49.678 110.794-110.75 110.794-61.095 0-110.773-49.7-110.773-110.794z" p-id="15876" />
                <path d="M511.371 960.81c-246.951 0-447.869-200.918-447.869-447.891 0-246.93 200.919-447.871 447.869-447.871 246.973 0 447.892 200.919 447.892 447.871 0 246.973-200.919 447.891-447.892 447.891z m0-854.269c-224.098 0-406.398 182.301-406.398 406.377s182.3 406.397 406.398 406.397c224.099 0 406.42-182.321 406.42-406.397S735.47 106.541 511.371 106.541z" p-id="15877" />
            </svg>
        </template>
        <template v-else>
            <m-dropdown :menu="menu" @item-click="handleNavClick">
                <svg t="1638284101714" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="36875" width="32" height="32">
                    <path d="M36.5056 512c0 262.656 211.8144 473.5488 475.4944 473.5488s475.4432-210.944 475.4432-473.5488S775.68 38.5024 512 38.5024 36.5056 249.4464 36.5056 512z" fill="#FFFFFF" p-id="36876" />
                    <path d="M36.5056 512c0 262.656 211.8144 475.648 475.4944 475.648s475.4432-212.992 475.4432-475.648S775.68 36.352 512 36.352 36.5056 249.4464 36.5056 512z" fill="#FFFFFF" p-id="36877" />
                    <path d="M512 996.3008C243.968 996.3008 25.7024 778.9056 25.7024 512 25.7024 242.9952 243.968 25.6 512 25.6s486.2464 217.3952 486.2464 486.4c0 266.9056-218.2656 484.3008-486.2464 484.3008zM512 47.104C254.7712 47.104 47.3088 255.8976 47.3088 512S254.7712 976.896 512 976.896s464.64-208.7424 464.64-464.896S769.1776 47.104 512 47.104z" fill="#EFEFEF" p-id="36878" />
                    <path d="M872.192 838.9632A486.5536 486.5536 0 0 1 511.8464 998.4a484.9152 484.9152 0 0 1-360.6016-160.256c-0.256-0.6144 0-0.8704 0.3072-1.4336 1.1264-3.3792 2.2528-6.7584 3.9424-10.1376-0.3072-0.256 0-0.512 0-0.512a69.632 69.632 0 0 1 4.8128-10.4448c-0.3072-0.3072 0-0.3072 0.256-0.5632 39.5264-81.8176 131.8912-127.6928 208.6912-133.0176l13.824-0.8192c14.1312-0.8704 28.2624-1.6896 42.3936-2.2528 5.632-0.3072 11.5712-0.3072 17.5104-0.5632 32.768-1.1264 65.792-1.4336 99.6352-0.8704 15.0016 0.3072 29.952 0.5632 45.4656 1.1264l14.6944 0.8704c14.9504 0.512 30.208 1.3824 46.08 2.2528 1.9456 0 3.8912 0.256 5.888 0.256 86.1184 5.632 169.1648 54.272 208.128 134.656 1.6896 3.4304 3.3792 6.8096 4.7616 10.4448 0.3072 0.3072 0.3072 0.3072 0.3072 0.5632 1.4336 3.072 2.56 6.4512 3.6864 9.8304a2.1504 2.1504 0 0 1 0.512 1.4336z" fill="#95A1B9" p-id="36879" />
                    <path d="M514.1504 761.7024c-49.7152 0-88.576-25.856-88.576-75.3152v-86.1184c0-49.5104 38.8608-88.2688 88.576-88.2688s88.576 38.7584 88.576 88.2688v86.1184c0 49.4592-38.912 75.264-88.576 75.264z" fill="#F8E9E9" p-id="36880" />
                    <path d="M524.9536 686.3872a232.448 232.448 0 0 0 79.9744-58.112v-32.3072H425.472v94.72c15.1552 4.3008 67.0208 8.6016 99.4304-4.3008z" fill="#B8B8B8" p-id="36881" />
                    <path d="M360.704 471.1424c0 101.1712 66.9696 182.9376 151.296 182.9376s151.296-81.7664 151.296-182.9376S596.224 288.2048 512 288.2048 360.704 369.9712 360.704 471.1424z" fill="#FFE8E8" p-id="36882" />
                    <path d="M578.9696 234.3936c-82.1248-17.2544-142.6432 17.2032-166.4 32.256-30.2592 19.4048-49.7152 45.2096-62.6688 75.3664s-15.1552 83.9168 6.4512 96.8192 58.368-2.1504 95.1296-32.256 140.4928-49.5104 140.4928-49.5104-15.1552 58.112 66.9696 107.6224c25.9584 15.0528 30.2592-64.5632 25.9584-99.0208-4.352-34.4576-23.808-114.0736-105.9328-131.2768z" fill="#7E8289" p-id="36883" />
                    <path d="M603.392 629.6064l45.4144 51.6608c0 21.504-13.0048 45.1584-34.6112 71.0144-19.456 23.6544-34.56 40.9088-47.5136 51.6608 0 2.1504 0 2.1504-2.2016 2.1504s-2.1504-2.1504-2.1504-4.3008c-2.1504-8.6016-6.4512-17.2544-17.2544-23.7056s-21.6576-12.9024-32.4608-17.2032c21.6064-10.752 41.0624-25.8048 56.2176-47.36 15.104-21.504 28.1088-49.5104 34.56-83.968z" fill="#CBD2DA" p-id="36884" />
                    <path d="M426.1888 631.7568l-43.2128 49.5104c2.1504 19.3536 12.9536 43.008 34.56 71.0144 19.456 23.6544 34.56 40.9088 47.5648 53.76 2.1504 2.2016 2.1504 2.2016 4.3008 2.2016v-6.4512c2.1504-10.752 6.5024-17.2544 17.3056-23.7056a236.544 236.544 0 0 1 32.4096-17.2032 133.0176 133.0176 0 0 1-56.2176-47.36 260.608 260.608 0 0 1-36.7104-81.7664z" fill="#CBD2DA" p-id="36885" />
                    <path d="M511.8464 25.7024C243.8656 25.7024 25.6 243.0464 25.6 511.8976c0 33.4848 3.3792 65.792 9.8816 97.28a483.4816 483.4816 0 0 0 115.7632 228.9152A484.9152 484.9152 0 0 0 511.8464 998.4a486.5536 486.5536 0 0 0 360.3456-159.4368 483.3792 483.3792 0 0 0 116.3264-229.7344 479.8976 479.8976 0 0 0 9.8816-97.28c0-268.9024-218.2656-486.2464-486.5536-486.2464z m-455.168 392.8576a462.6944 462.6944 0 0 1 384.3072-366.1312C456.4992 50.176 472.064 48.4864 487.8336 47.616c7.936-0.256 16.128-0.512 24.064-0.512 7.8848 0 16.0768 0.256 23.9616 0.512 15.8208 0.8704 31.3344 2.56 46.8992 4.8128a463.0528 463.0528 0 0 1 384.6144 366.1312c6.144 30.0544 9.2672 61.2864 9.2672 93.3376 0 48.384-7.3216 94.5152-20.8896 138.0864a428.1856 428.1856 0 0 1-35.0208 83.5072 439.0912 439.0912 0 0 1-57.856 83.2512c-7.0656 8.192-14.4384 16.0256-22.016 23.6032a466.1248 466.1248 0 0 1-329.0112 134.4512 463.616 463.616 0 0 1-351.232-159.744 466.0736 466.0736 0 0 1-67.5328-101.7856 462.2336 462.2336 0 0 1-45.7216-201.3696c0-32.0512 3.072-63.2832 9.3184-93.3376z" fill="#EFEFEF" p-id="36886" />
                </svg>
            </m-dropdown>
        </template>
    </div>
    <m-login v-if="showLoginPanel" v-model:show="showLoginPanel"></m-login>
    <transition name="opacity">
        <m-manger v-if="showAdminPanel" v-model="showAdminPanel"></m-manger>
    </transition>
</template>

<script>
import tcb from '@/tcb'
import { getScrollWidth, hasScrollbar } from '@/util'
import { mLogin, mDropdown } from '+/'
import mManger from './layout.vue'

export default {
    components: {
        mLogin,
        mManger,
        mDropdown
    },
    props: {
        env: {
            type: String,
            required: true
        }
    },
    data () {
        return {
            user: null,
            config: {},
            showLoginPanel: false,// 登录注册
            showAdminPanel: false,
            menu: [
                { label: '评论管理', value: 'mange' },
                { label: '退出', value: 'out' }
            ]
        }
    },
    watch: {
        showAdminPanel: function (val) {
            if (val) {
                if (hasScrollbar()) {
                    document.body.style.width = `calc(100% - ${getScrollWidth()}px)`;
                    document.body.style.overflow = "hidden";
                }
            } else {
                if (hasScrollbar()) {
                    document.body.style.width = "";
                    document.body.style.overflow = "";
                }
            }
        }
    },
    methods: {
        init () {
            tcb.initApp({ env: this.env }).then(_ => {
                const setUser = (user) => {
                    if (user && user.loginType !== "ANONYMOUS") {
                        this.user = tcb.cloudbase.auth.currentUser
                    }
                }
                setUser(tcb.cloudbase.auth.currentUser)
                tcb.cloudbase.auth.onLoginStateChanged((loginState) => {
                    if (loginState) {
                        setUser(loginState.user)
                        this.setConfig()
                    }
                });
                this.setConfig()
            })

        },
        // 获取配置
        async setConfig () {
            this.config = await tcb.callFunction('getConfig')
        },
        handleShowAdminPanel () {
            if (this.config.is_admin) {
                this.showAdminPanel = true
            }
        },
        handleNavClick ({ value }) {
            switch (value) {
                case 'out':
                    tcb.signOut().then(_ => {
                        this.user = null
                    });
                    break;
                case 'mange':
                    this.handleShowAdminPanel()
                    break;
            }
        }
    },
    created () {
        this.init()
    }
}
</script>
<style lang="less">
@import url("../../styles/index.less");
.login-icon {
    display: inline-block;
    width: 32px;
    height: 32px;
    background-color: rgb(255, 255, 255);
    border-radius: 50%;
}
</style>

